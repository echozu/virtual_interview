<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.echo.virtual_interview.mapper.ChatsMessagesMapper">

    <!--
        查询指定会话ID的最后N条消息。
        通过子查询先按创建时间倒序（DESC）并限制数量（LIMIT），
        然后再对结果集按创建时间正序（ASC）排列，以确保返回的对话历史是按时间顺序的。
    -->
    <select id="selectLastNMessages" resultType="com.echo.virtual_interview.model.entity.ChatsMessages">
        SELECT * FROM (
                          SELECT * FROM chats_messages
                          WHERE chat_id = #{chatId}
                          ORDER BY created_at DESC
                          LIMIT #{lastN}
                      ) AS last_messages
        ORDER BY created_at ASC
    </select>

</mapper>
