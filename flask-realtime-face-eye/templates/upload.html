<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>面试官AI助手 - 视频分析</title>
    <!-- 引入Tailwind CSS，用于快速美化页面 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 自定义一些样式，让页面更好看 */
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }
        /* 美化滚动条 */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1f2937;
        }
        ::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }
        /* 按钮禁用时的样式 */
        button:disabled {
            cursor: not-allowed;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 flex items-center justify-center min-h-screen">

<div class="container max-w-2xl w-full mx-auto p-8 bg-gray-800 rounded-2xl shadow-2xl border border-gray-700">
    <div class="text-center mb-8">
        <h1 class="text-3xl font-bold text-white">面试官AI助手 - 视频分析</h1>
        <p class="text-gray-400 mt-2">上传面试视频，系统将通过异步任务进行深度分析，并通过轮询获取实时反馈。</p>
    </div>

    <!-- 上传表单 -->
    <form id="upload-form" enctype="multipart/form-data" class="space-y-6">

        <!-- Session ID 输入框 -->
        <div>
            <label for="session-id" class="block mb-2 text-sm font-medium text-gray-300">面试会话ID (Session ID)</label>
            <input type="text" id="session-id" name="sessionId" value="test-session-12345" required
                   class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-3 placeholder-gray-400">
        </div>

        <div>
            <!-- 文件选择输入框 -->
            <label for="video-input" class="block mb-2 text-sm font-medium text-gray-300">选择视频文件</label>
            <input type="file" id="video-input" name="video" accept="video/*" required
                   class="block w-full text-sm text-gray-400 rounded-lg border border-gray-600 cursor-pointer bg-gray-700 focus:outline-none
                          file:mr-4 file:py-3 file:px-5 file:rounded-l-lg file:border-0
                          file:text-sm file:font-semibold file:bg-blue-600 file:text-white hover:file:bg-blue-700
                          transition-all duration-300">
        </div>

        <!-- 开始分析按钮 -->
        <button type="submit" id="submit-btn"
                class="w-full py-3 px-4 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-50 transition-transform transform hover:scale-105 disabled:bg-gray-500 disabled:transform-none">
            开始分析
        </button>
    </form>

    <!-- 状态和加载器区域 -->
    <div id="status-area" class="mt-6 text-center h-16 flex items-center justify-center">
        <!-- 加载器，默认隐藏 -->
        <div id="loader" class="hidden items-center space-x-3">
            <!-- SVG加载动画 -->
            <svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span id="loader-text" class="font-medium"></span>
        </div>
    </div>

    <!-- 结果显示区域 -->
    <div>
        <h2 class="text-xl font-semibold text-white mb-3">分析结果:</h2>
        <pre id="results" class="bg-gray-900 p-4 rounded-md text-sm text-left overflow-x-auto min-h-[100px] border border-gray-700">请上传视频以开始分析。</pre>
    </div>
</div>

<script>
    const uploadForm = document.getElementById('upload-form');
    const submitBtn = document.getElementById('submit-btn');
    const resultsDiv = document.getElementById('results');
    const loader = document.getElementById('loader');
    const loaderText = document.getElementById('loader-text');
    const videoInput = document.getElementById('video-input'); // 获取文件输入框

    // 轮询配置
    const POLLING_INTERVAL = 3000; // 3秒轮询一次
    const MAX_POLLING_ATTEMPTS = 100; // 最多轮询100次 (5分钟)
    let pollingIntervalId = null;

    // 更新UI的函数
    function updateStatus(text, showSpinner = true) {
        if (text) {
            loader.style.display = 'flex';
            loaderText.textContent = text;
            loader.querySelector('svg').style.display = showSpinner ? 'block' : 'none';
        } else {
            loader.style.display = 'none';
        }
    }

    // 轮询函数
    async function startPolling(analysisId, javaBackendUrl) {
        let attempts = 0;
        updateStatus('✔️ 任务已创建! 正在等待分析结果...');

        // ❗ 注意: 在实际项目中，这个token应该在用户登录后从localStorage或cookie中动态获取。
        const token = 'eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiIxIiwidXNlcm5hbWUiOiJlY2hvIiwiaWF0IjoxNzUxNzAzMDc2LCJleHAiOjE3NTE3ODk0NzZ9.EfsJXTzrPwMcDmTi3mTvBCaMUb6ll_ICYN-BkksdoOs';

        pollingIntervalId = setInterval(async () => {
            if (attempts >= MAX_POLLING_ATTEMPTS) {
                clearInterval(pollingIntervalId);
                updateStatus('❌ 轮询超时，请稍后重试或联系管理员。', false);
                submitBtn.disabled = false;
                videoInput.disabled = false;
                return;
            }

            try {
                // ✅ 已修复: 修正了URL路径，添加了 /process/
                const response = await fetch(`${javaBackendUrl}/api/interview/process/analysis/result/${analysisId}`, {
                    method: 'GET', // 明确指定方法
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    // 如果是401或403，说明token无效或权限不足
                    if (response.status === 401 || response.status === 403) {
                        clearInterval(pollingIntervalId);
                        updateStatus('❌ 验证失败，请重新登录。', false);
                        submitBtn.disabled = false;
                        videoInput.disabled = false;
                        return;
                    }
                    console.warn(`Polling request failed with status: ${response.status}`);
                    return;
                }
                const result = await response.json();

                // 增加日志，帮助调试
                console.log("轮询结果:", result);

                // 增加健壮性检查
                if (!result || typeof result.data === 'undefined') {
                    console.error("轮询返回的JSON格式不正确，缺少 'data' 字段。", result);
                    return;
                }

                // 根据Java后端返回的状态更新UI
                switch (result.data.status) {
                    case 'PENDING':
                        updateStatus(`⏳ 分析进行中... (${result.data.data || ''})`);
                        break;
                    case 'COMPLETED':
                        clearInterval(pollingIntervalId);
                        updateStatus(null);
                        // 确保 result.data.data 存在且是一个对象
                        if (result.data.data && typeof result.data.data === 'object') {
                            resultsDiv.textContent = "✅ 分析完成!\n" + JSON.stringify(result.data.data, null, 2);
                        } else {
                            resultsDiv.textContent = "✅ 分析完成，但结果格式异常。\n" + JSON.stringify(result.data, null, 2);
                        }
                        submitBtn.disabled = false;
                        videoInput.disabled = false;
                        break;
                    case 'FAILED':
                        clearInterval(pollingIntervalId);
                        updateStatus('❌ 分析任务失败。', false);
                        resultsDiv.textContent = "错误详情: " + JSON.stringify(result.data.data, null, 2);
                        submitBtn.disabled = false;
                        videoInput.disabled = false;
                        break;
                }

            } catch (error) {
                console.error('轮询时发生网络或JSON解析错误:', error);
                // 如果是JSON解析错误，可能需要停止轮询
                if (error instanceof SyntaxError) {
                    clearInterval(pollingIntervalId);
                    updateStatus('❌ 接收到无法解析的响应，请检查后端服务。', false);
                    submitBtn.disabled = false;
                    videoInput.disabled = false;
                }
            } finally {
                attempts++;
            }
        }, POLLING_INTERVAL);
    }

    // 表单提交逻辑
    uploadForm.addEventListener('submit', async function (event) {
        event.preventDefault();

        if (!videoInput.files || videoInput.files.length === 0) {
            resultsDiv.textContent = "请先选择一个视频文件。";
            return;
        }

        if(pollingIntervalId) clearInterval(pollingIntervalId);

        const formData = new FormData(uploadForm);
        const pythonServiceUrl = 'http://123.207.53.16:55274'; // 你的Python服务地址
        const javaBackendUrl = 'http://123.207.53.16:9527'; // ❗❗❗ 请替换为你的Java后端地址

        resultsDiv.textContent = '正在上传视频并创建分析任务...';
        updateStatus('⚙️ 上传中...');
        submitBtn.disabled = true;
        videoInput.disabled = true;

        try {
            const response = await fetch(`${pythonServiceUrl}/api/analyze_video`, {
                method: 'POST',
                body: formData
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || `HTTP 错误! 状态码: ${response.status}`);
            }

            const data = await response.json();

            if (data.analysisId) {
                resultsDiv.textContent = `任务创建成功，ID: ${data.analysisId}\n即将开始轮询获取结果...`;
                startPolling(data.analysisId, javaBackendUrl);
            } else {
                throw new Error("未能从后端获取有效的分析任务ID。");
            }

        } catch (error) {
            updateStatus(null);
            resultsDiv.textContent = '❌ 发生错误: ' + error.message;
            submitBtn.disabled = false;
            videoInput.disabled = false;
            console.error('Error:', error);
        }
    });
</script>
</body>
</html>
